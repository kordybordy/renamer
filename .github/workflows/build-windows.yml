name: Build Windows EXE

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"


      - name: Install Python deps (incl PyInstaller)
        run: |
          python -m pip install --upgrade pip
          python -m pip install --no-cache-dir -r requirements.txt
          python -m pip install --no-cache-dir pyinstaller
          python -m pip show pyinstaller
          python -c "import PyInstaller; print('PyInstaller OK', PyInstaller.__version__)"

      # ---------- POPPLER (pdftoppm) ----------
      - name: Download & prepare Poppler
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
      
          $popplerZip = "Release-25.12.0-0.zip"
          $popplerUrl = "https://github.com/oschwartz10612/poppler-windows/releases/download/v25.12.0-0/$popplerZip"
      
          New-Item -ItemType Directory -Force -Path "poppler" | Out-Null
      
          curl.exe -L $popplerUrl -o $popplerZip
          Expand-Archive -Path $popplerZip -DestinationPath "poppler" -Force
      
          $dir = Get-ChildItem -Path "poppler" -Directory | Select-Object -First 1
          if (-not $dir) { throw "Poppler extract failed" }
      
          if (Test-Path "poppler\Library") { Remove-Item "poppler\Library" -Recurse -Force }
          Move-Item -Path (Join-Path $dir.FullName "Library") -Destination "poppler\Library" -Force
      
          if (-not (Test-Path "poppler\Library\bin\pdftoppm.exe")) {
            throw "pdftoppm.exe not found after Poppler setup"
          }


      # ---------- TESSERACT ----------
      - name: Install Tesseract via Chocolatey
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          choco install tesseract -y

          # Copy into local ./tesseract folder so PyInstaller --add-data works
          $src = "C:\Program Files\Tesseract-OCR"
          if (-not (Test-Path $src)) { throw "Tesseract not found at $src" }

          if (Test-Path "tesseract") { Remove-Item "tesseract" -Recurse -Force }
          Copy-Item -Path $src -Destination "tesseract" -Recurse -Force

      - name: Ensure Polish traineddata present (pol)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path "tesseract\tessdata" | Out-Null
      
          $polUrl = "https://raw.githubusercontent.com/tesseract-ocr/tessdata/main/pol.traineddata"
          curl.exe -L $polUrl -o "tesseract\tessdata\pol.traineddata"
      
          if (-not (Test-Path "tesseract\tessdata\pol.traineddata")) {
            throw "pol.traineddata download failed"
          }

      # ---------- BUILD ----------
      - name: Build (onedir)
        shell: pwsh
        run: |
          python -m PyInstaller --onedir --windowed --name Renamer --icon "assets\logo.ico" --clean --noconfirm --add-data "assets;assets" --add-data "modern.qss;." --add-data "retro.qss;." --add-data "poppler\Library;poppler\Library" --add-data "tesseract;tesseract" main.py

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Renamer-onedir
          path: dist/Renamer/**
